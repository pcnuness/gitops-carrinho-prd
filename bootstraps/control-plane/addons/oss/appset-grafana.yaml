---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: addons-oss-grafana
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    gitops.plataform/area: observability
    gitops.plataform/service: grafana
    gitops.plataform/component: monitoring
    gitops.plataform/managed-by: foundations
spec:
  syncPolicy:
    preserveResourcesOnDeletion: true
  generators:
    - clusters:
        values:
          addonChart: grafana
          addonChartReleaseName: grafana
          addonChartNamespace: observability
  template:
    metadata:
      name: addon-oss-{{values.addonChart}}-{{name}}
    spec:
      project: cluster-management
      sources:
        # Source 1: Repositório central (platform-addons-charts) - valores base
        - repoURL: 'https://github.com/pcnuness/platform-addons-charts.git'
          targetRevision: 'main'  # Use 'main' para develop, tags (v0.x.x) para prod
          ref: values-central
        # Source 2: Repositório do cluster (gitops-carrinho-prd) - customizações
        - repoURL: 'https://github.com/pcnuness/gitops-carrinho-prd.git'
          targetRevision: 'main'
          ref: values-cluster
        # Source 3: Chart principal do addon (centralizado)
        - repoURL: 'https://github.com/pcnuness/platform-addons-charts.git'
          targetRevision: 'main'  # Controle de versão: 'main' ou 'v0.x.x'
          path: addons/{{values.addonChart}}
          helm:
            valueFiles:
              # Ordem de precedência: último sobrescreve os anteriores
              - $values-central/addons/{{values.addonChart}}/values.yaml
              - $values-cluster/addons/{{values.addonChart}}/values.yaml
            ignoreMissingValueFiles: true
      destination:
        namespace: '{{values.addonChartNamespace}}'
        name: '{{name}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true

