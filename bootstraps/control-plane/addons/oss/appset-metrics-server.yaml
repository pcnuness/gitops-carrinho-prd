---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: addons-oss-metrics-server
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    gitops.plataform/area: monitoring
    gitops.plataform/service: metrics
    gitops.plataform/component: metrics-server
    gitops.plataform/managed-by: foundations
spec:
  syncPolicy:
    preserveResourcesOnDeletion: true
  generators:
    - clusters:
        values:
          addonChart: metrics-server
          addonChartNamespace: kube-system
  template:
    metadata:
      name: addon-oss-{{values.addonChart}}-{{name}}
    spec:
      project: cluster-management
      sources:
        # Source 1: Repositório central (platform-addons-charts) - valores base
        - repoURL: 'https://github.com/pcnuness/platform-addons-charts.git'
          targetRevision: 'main'  # Use 'main' para develop, tags (v0.x.x) para prod
          ref: values-central
        # Source 2: Repositório do cluster (gitops-cluster-management) - customizações
        - repoURL: 'https://github.com/pcnuness/gitops-cluster-management.git'
          targetRevision: 'main'
          ref: values-cluster
        # Source 3: Chart principal do addon (centralizado)
        - repoURL: 'https://github.com/pcnuness/platform-addons-charts.git'
          targetRevision: 'main'  # Controle de versão: 'main' ou 'v0.x.x'
          path: addons/{{values.addonChart}}
          helm:
            valueFiles:
              # Ordem de precedência: último sobrescreve os anteriores
              - $values-central/addons/{{values.addonChart}}/values.yaml
              - $values-cluster/addons/{{values.addonChart}}/values.yaml
            ignoreMissingValueFiles: true
      destination:
        namespace: '{{values.addonChartNamespace}}'
        name: '{{name}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true

